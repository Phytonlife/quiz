<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–Ω–ª–∞–π–Ω –ö–≤–∏–∑-–ò–≥—Ä–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .input-group {
            margin: 20px 0;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin: 10px 0;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .room-code {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            letter-spacing: 3px;
        }

        .players-list {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .player-item {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .host-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
        }

        .question-container {
            margin: 30px 0;
        }

        .question-number {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 30px 0;
        }

        .answer-btn {
            background: white;
            border: 3px solid #e0e0e0;
            padding: 20px;
            border-radius: 15px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .answer-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .answer-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .answer-btn.correct {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .answer-btn.incorrect {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .timer {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: conic-gradient(#667eea 0deg, #e0e0e0 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            position: relative;
        }

        .timer::before {
            content: '';
            position: absolute;
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            z-index: 1;
        }

        .timer-text {
            position: relative;
            z-index: 2;
        }

        .score-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .leaderboard {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 18px;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .position {
            font-weight: bold;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }

        .position.gold { background: #ffd700; color: #333; }
        .position.silver { background: #c0c0c0; color: #333; }
        .position.bronze { background: #cd7f32; color: white; }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            color: #155724;
            background: #d4edda;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .answers-grid {
                grid-template-columns: 1fr;
            }
            
            .answer-btn {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="homeScreen" class="screen active">
            <h1>üß† –ö–≤–∏–∑-–ò–≥—Ä–∞</h1>
            <p>–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∏–≥—Ä–µ!</p>
            
            <div class="input-group">
                <input type="text" id="playerName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" maxlength="20">
            </div>
            
            <button class="btn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            
            <div class="input-group">
                <input type="text" id="roomCode" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" maxlength="6">
                <button class="btn" onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
            
            <div id="homeError" class="error" style="display: none;"></div>
        </div>

        <!-- –õ–æ–±–±–∏ -->
        <div id="lobbyScreen" class="screen">
            <h2>–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!</h2>
            <div id="displayRoomCode" class="room-code"></div>
            
            <button class="btn" onclick="copyRoomCode()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
            <button class="btn" onclick="shareRoom()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π</button>
            
            <div class="players-list">
                <h3>–ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ:</h3>
                <div id="playersList"></div>
            </div>
            
            <div id="hostControls" style="display: none;">
                <button class="btn" onclick="startGame()" id="startBtn">üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
            </div>
            
            <button class="btn" onclick="leaveRoom()">üö™ –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
        </div>

        <!-- –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω -->
        <div id="gameScreen" class="screen">
            <div class="score-display">
                –û—á–∫–∏: <span id="playerScore">0</span>
            </div>
            
            <div class="question-container">
                <div class="question-number">
                    –í–æ–ø—Ä–æ—Å <span id="questionNumber">1</span> –∏–∑ 10
                </div>
                
                <div class="timer">
                    <div class="timer-text" id="timerDisplay">10</div>
                </div>
                
                <div class="question-text" id="questionText"></div>
                
                <div class="answers-grid" id="answersGrid"></div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div id="resultsScreen" class="screen">
            <h2>üèÜ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã</h2>
            
            <div class="leaderboard" id="leaderboard"></div>
            
            <div id="hostResultsControls" style="display: none;">
                <button class="btn" onclick="startNewGame()">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
            </div>
            
            <button class="btn" onclick="backToHome()">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>

    <script>
        // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ—é)
        const firebaseConfig = {
  apiKey: "AIzaSyD4glxungrmAG-EVQPdTxoIX6n6K4345yk",
  authDomain: "quizgame-a61d1.firebaseapp.com",
  databaseURL: "https://quizgame-a61d1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "quizgame-a61d1",
  storageBucket: "quizgame-a61d1.firebasestorage.app",
  messagingSenderId: "230712996432",
  appId: "1:230712996432:web:0cd7dda2784dcc993f1755"
};

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentRoom = null;
        let currentPlayer = null;
        let isHost = false;
        let gameState = {
            currentQuestion: 0,
            questions: [],
            answers: {},
            score: 0,
            timeLeft: 10,
            timerInterval: null
        };

        // –ë–∞–∑–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
        const questionsBank = [
            {
                question: "–ö–∞–∫–∞—è –ø–ª–∞–Ω–µ—Ç–∞ —Å–∞–º–∞—è –±–æ–ª—å—à–∞—è –≤ –°–æ–ª–Ω–µ—á–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ?",
                options: ["–ó–µ–º–ª—è", "–Æ–ø–∏—Ç–µ—Ä", "–°–∞—Ç—É—Ä–Ω", "–ù–µ–ø—Ç—É–Ω"],
                correct: 1
            },
            {
                question: "–í –∫–∞–∫–æ–º –≥–æ–¥—É –Ω–∞—á–∞–ª–∞—Å—å –í—Ç–æ—Ä–∞—è –º–∏—Ä–æ–≤–∞—è –≤–æ–π–Ω–∞?",
                options: ["1938", "1939", "1940", "1941"],
                correct: 1
            },
            {
                question: "–ö—Ç–æ –Ω–∞–ø–∏—Å–∞–ª —Ä–æ–º–∞–Ω '–í–æ–π–Ω–∞ –∏ –º–∏—Ä'?",
                options: ["–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", "–¢–æ–ª—Å—Ç–æ–π", "–ü—É—à–∫–∏–Ω", "–ß–µ—Ö–æ–≤"],
                correct: 1
            },
            {
                question: "–ö–∞–∫–æ–π —Ö–∏–º–∏—á–µ—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç—Å—è —Å–∏–º–≤–æ–ª–æ–º 'O'?",
                options: ["–û–ª–æ–≤–æ", "–ö–∏—Å–ª–æ—Ä–æ–¥", "–û—Å–º–∏–π", "–û–∑–æ–Ω"],
                correct: 1
            },
            {
                question: "–°–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ –ó–µ–º–ª–µ?",
                options: ["5", "6", "7", "8"],
                correct: 2
            },
            {
                question: "–ö–∞–∫–∞—è —Å–∞–º–∞—è –¥–ª–∏–Ω–Ω–∞—è —Ä–µ–∫–∞ –≤ –º–∏—Ä–µ?",
                options: ["–ê–º–∞–∑–æ–Ω–∫–∞", "–ù–∏–ª", "–í–æ–ª–≥–∞", "–ú–∏—Å—Å–∏—Å–∏–ø–∏"],
                correct: 1
            },
            {
                question: "–í –∫–∞–∫–æ–º –≥–æ–¥—É —á–µ–ª–æ–≤–µ–∫ –≤–ø–µ—Ä–≤—ã–µ –≤—ã—Å–∞–¥–∏–ª—Å—è –Ω–∞ –õ—É–Ω—É?",
                options: ["1967", "1968", "1969", "1970"],
                correct: 2
            },
            {
                question: "–ö–∞–∫–æ–π –≥–∞–∑ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –±–æ–ª—å—à—É—é —á–∞—Å—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã –ó–µ–º–ª–∏?",
                options: ["–ö–∏—Å–ª–æ—Ä–æ–¥", "–ê–∑–æ—Ç", "–£–≥–ª–µ–∫–∏—Å–ª—ã–π –≥–∞–∑", "–ê—Ä–≥–æ–Ω"],
                correct: 1
            },
            {
                question: "–ö—Ç–æ –∏–∑–æ–±—Ä–µ–ª —Ç–µ–ª–µ—Ñ–æ–Ω?",
                options: ["–≠–¥–∏—Å–æ–Ω", "–ë–µ–ª–ª", "–¢–µ—Å–ª–∞", "–ú–∞—Ä–∫–æ–Ω–∏"],
                correct: 1
            },
            {
                question: "–ö–∞–∫–∞—è —Å—Ç–æ–ª–∏—Ü–∞ –ê–≤—Å—Ç—Ä–∞–ª–∏–∏?",
                options: ["–°–∏–¥–Ω–µ–π", "–ú–µ–ª—å–±—É—Ä–Ω", "–ö–∞–Ω–±–µ—Ä—Ä–∞", "–ë—Ä–∏—Å–±–µ–Ω"],
                correct: 2
            },
            {
                question: "–°–∫–æ–ª—å–∫–æ –∫–æ—Å—Ç–µ–π –≤ —Ç–µ–ª–µ –≤–∑—Ä–æ—Å–ª–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞?",
                options: ["196", "206", "216", "226"],
                correct: 1
            },
            {
                question: "–ö–∞–∫–æ–π —Å–∞–º—ã–π –º–∞–ª–µ–Ω—å–∫–∏–π –æ–∫–µ–∞–Ω?",
                options: ["–ê—Ç–ª–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π", "–ò–Ω–¥–∏–π—Å–∫–∏–π", "–°–µ–≤–µ—Ä–Ω—ã–π –õ–µ–¥–æ–≤–∏—Ç—ã–π", "–¢–∏—Ö–∏–π"],
                correct: 2
            },
            {
                question: "–í –∫–∞–∫–æ–º –≥–æ–¥—É –ø–∞–ª –ë–µ—Ä–ª–∏–Ω—Å–∫–∏–π —Å—Ç–µ–Ω–∞?",
                options: ["1987", "1988", "1989", "1990"],
                correct: 2
            },
            {
                question: "–ö–∞–∫–∞—è –ø–ª–∞–Ω–µ—Ç–∞ –±–ª–∏–∂–∞–π—à–∞—è –∫ –°–æ–ª–Ω—Ü—É?",
                options: ["–í–µ–Ω–µ—Ä–∞", "–ó–µ–º–ª—è", "–ú–µ—Ä–∫—É—Ä–∏–π", "–ú–∞—Ä—Å"],
                correct: 2
            },
            {
                question: "–ö—Ç–æ —Å–æ–∑–¥–∞–ª —Å–æ—Ü–∏–∞–ª—å–Ω—É—é —Å–µ—Ç—å Facebook?",
                options: ["–ë–∏–ª–ª –ì–µ–π—Ç—Å", "–°—Ç–∏–≤ –î–∂–æ–±—Å", "–ú–∞—Ä–∫ –¶—É–∫–µ—Ä–±–µ—Ä–≥", "–õ–∞—Ä—Ä–∏ –ü–µ–π–¥–∂"],
                correct: 2
            }
        ];

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        function generatePlayerId() {
            return Math.random().toString(36).substr(2, 10);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        async function createRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            
            if (!playerName) {
                showError('homeError', '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }
            if (playerName.length < 3 || playerName.length > 20) {
                showError('homeError', '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 3 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            try {
                currentRoom = generateRoomCode();
                currentPlayer = {
                    id: generatePlayerId(),
                    name: playerName,
                    score: 0,
                    isHost: true
                };
                isHost = true;

                const roomRef = database.ref(`rooms/${currentRoom}`);
                
                await roomRef.set({
                    info: {
                        hostId: currentPlayer.id,
                        status: 'waiting',
                        currentQuestion: -1,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    },
                    players: {
                        [currentPlayer.id]: currentPlayer
                    }
                });

                document.getElementById('displayRoomCode').textContent = currentRoom;
                document.getElementById('hostControls').style.display = 'block';
                
                listenToRoom();
                showScreen('lobbyScreen');
                
            } catch (error) {
                showError('homeError', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã: ' + error.message);
            }
        }

        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
        async function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            
            if (!playerName) {
                showError('homeError', '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }
            if (playerName.length < 3 || playerName.length > 20) {
                showError('homeError', '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 3 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }
            if (!roomCode) {
                showError('homeError', '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }

            try {
                const roomRef = database.ref(`rooms/${roomCode}`);
                const roomSnapshot = await roomRef.once('value');
                
                if (!roomSnapshot.exists()) {
                    showError('homeError', '–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }

                const roomData = roomSnapshot.val();
                if (roomData.info.status !== 'waiting') {
                    showError('homeError', '–ò–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å');
                    return;
                }

                currentRoom = roomCode;
                currentPlayer = {
                    id: generatePlayerId(),
                    name: playerName,
                    score: 0,
                    isHost: false
                };
                isHost = false;

                await roomRef.child(`players/${currentPlayer.id}`).set(currentPlayer);

                document.getElementById('displayRoomCode').textContent = currentRoom;
                document.getElementById('hostControls').style.display = 'none';
                
                listenToRoom();
                showScreen('lobbyScreen');
                
            } catch (error) {
                showError('homeError', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            }
        }

        // –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–º–Ω–∞—Ç–µ
        function listenToRoom() {
            const roomRef = database.ref(`rooms/${currentRoom}`);
            
            roomRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    alert('–ö–æ–º–Ω–∞—Ç–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞');
                    backToHome();
                    return;
                }

                const roomData = snapshot.val();
                updatePlayersList(roomData.players);
                
                if (roomData.info.status === 'playing') {
                    if (document.getElementById('lobbyScreen').classList.contains('active')) {
                        startGameplay(roomData);
                    }
                } else if (roomData.info.status === 'finished') {
                    showResults(roomData);
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
        function updatePlayersList(players) {
            const playersListEl = document.getElementById('playersList');
            playersListEl.innerHTML = '';
            
            Object.values(players).forEach(player => {
                const playerEl = document.createElement('div');
                playerEl.className = 'player-item';
                playerEl.innerHTML = `
                    <span>${player.name}</span>
                    ${player.isHost ? '<span class="host-badge">–•–æ—Å—Ç</span>' : ''}
                `;
                playersListEl.appendChild(playerEl);
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ä—Ç–∞
            const startBtn = document.getElementById('startBtn');
            if (startBtn && isHost) {
                const playerCount = Object.keys(players).length;
                startBtn.disabled = playerCount < 2;
                startBtn.textContent = playerCount < 2 ? 
                    '‚è≥ –ñ–¥–µ–º –∏–≥—Ä–æ–∫–æ–≤...' : 'üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É';
            }
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã
        function copyRoomCode() {
            navigator.clipboard.writeText(currentRoom).then(() => {
                const success = document.createElement('div');
                success.className = 'success';
                success.textContent = '–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!';
                document.getElementById('lobbyScreen').appendChild(success);
                setTimeout(() => success.remove(), 3000);
            });
        }

        // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π
        function shareRoom() {
            const url = `${window.location.href}?room=${currentRoom}`;
            navigator.clipboard.writeText(url).then(() => {
                const success = document.createElement('div');
                success.className = 'success';
                success.textContent = '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!';
                document.getElementById('lobbyScreen').appendChild(success);
                setTimeout(() => success.remove(), 3000);
            });
        }

        // –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã
        async function startGame() {
            if (!isHost) return;

            try {
                // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ 10 –≤–æ–ø—Ä–æ—Å–æ–≤
                const shuffled = questionsBank.sort(() => 0.5 - Math.random());
                const selectedQuestions = shuffled.slice(0, 10);

                const roomRef = database.ref(`rooms/${currentRoom}`);
                
                await roomRef.child('info').update({
                    status: 'playing',
                    currentQuestion: 0,
                    questionStartTime: firebase.database.ServerValue.TIMESTAMP
                });

                await roomRef.child('questions').set(selectedQuestions);

                gameState.questions = selectedQuestions;
                gameState.currentQuestion = 0;
                gameState.score = 0;
                
            } catch (error) {
                showError('homeError', '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã: ' + error.message);
            }
        }

        // –ù–∞—á–∞–ª–æ –≥–µ–π–º–ø–ª–µ—è
        function startGameplay(roomData) {
            gameState.questions = Object.values(roomData.questions || {});
            gameState.currentQuestion = roomData.info.currentQuestion;
            
            showScreen('gameScreen');
            listenToGameState();
            displayQuestion();
        }

        // –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
        function listenToGameState() {
            const gameRef = database.ref(`rooms/${currentRoom}/info`);
            
            gameRef.on('value', (snapshot) => {
                const info = snapshot.val();
                if (info.status === 'finished') {
                    clearInterval(gameState.timerInterval);
                    showResults();
                } else if (info.currentQuestion !== gameState.currentQuestion) {
                    gameState.currentQuestion = info.currentQuestion;
                    if (gameState.currentQuestion < gameState.questions.length) {
                        displayQuestion();
                    }
                }
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞
        function displayQuestion() {
            if (gameState.currentQuestion >= gameState.questions.length) {
                finishGame();
                return;
            }

            const question = gameState.questions[gameState.currentQuestion];
            
            document.getElementById('questionNumber').textContent = gameState.currentQuestion + 1;
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('playerScore').textContent = gameState.score;

            const answersGrid = document.getElementById('answersGrid');
            answersGrid.innerHTML = '';

            question.options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = option;
                btn.onclick = () => selectAnswer(index);
                answersGrid.appendChild(btn);
            });

            startTimer();
        }

        // –¢–∞–π–º–µ—Ä
        function startTimer() {
            gameState.timeLeft = 10;
            updateTimerDisplay();

            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft--;
                updateTimerDisplay();

                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timerInterval);
                    setTimeout(() => {
                        if (isHost) {
                            nextQuestion();
                        }
                    }, 1500);
                }
            }, 1000);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
        function updateTimerDisplay() {
            const timerEl = document.getElementById('timerDisplay');
            const timer = document.querySelector('.timer');
            
            timerEl.textContent = gameState.timeLeft;
            
            const percentage = (gameState.timeLeft / 10) * 360;
            timer.style.background = `conic-gradient(#667eea ${percentage}deg, #e0e0e0 ${percentage}deg)`;
        }

        // –í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞
        async function selectAnswer(answerIndex) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–±—Ä–∞–Ω –ª–∏ —É–∂–µ –æ—Ç–≤–µ—Ç
            if (Object.keys(gameState.answers).includes(gameState.currentQuestion.toString())) {
                return;
            }

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.style.pointerEvents = 'none';
            });

            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
            document.querySelectorAll('.answer-btn')[answerIndex].classList.add('selected');

            try {
                gameState.answers[gameState.currentQuestion] = answerIndex;
                await database.ref(`rooms/${currentRoom}/answers/${gameState.currentQuestion}/${currentPlayer.id}`).set({
                    answer: answerIndex,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞
                const question = gameState.questions[gameState.currentQuestion];
                if (answerIndex === question.correct && gameState.timeLeft > 0) {
                    gameState.score++;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                    await database.ref(`rooms/${currentRoom}/players/${currentPlayer.id}/score`).set(gameState.score);
                    
                    const success = document.createElement('div');
                    success.className = 'success';
                    success.textContent = '–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç!';
                    document.getElementById('gameScreen').appendChild(success);
                    setTimeout(() => success.remove(), 1500);
                } else {
                    const error = document.createElement('div');
                    error.className = 'error';
                    error.textContent = '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç!';
                    document.getElementById('gameScreen').appendChild(error);
                    setTimeout(() => error.remove(), 1500);
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:', error);
            }
        }

        // –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ö–æ—Å—Ç–∞)
        async function nextQuestion() {
            if (!isHost) return;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
            const question = gameState.questions[gameState.currentQuestion];
            const answerBtns = document.querySelectorAll('.answer-btn');
            
            answerBtns.forEach((btn, index) => {
                if (index === question.correct) {
                    btn.classList.add('correct');
                } else if (gameState.answers[gameState.currentQuestion] === index) {
                    btn.classList.add('incorrect');
                }
                btn.style.pointerEvents = 'none';
            });

            // –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã, –∑–∞—Ç–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
            setTimeout(async () => {
                const nextQuestionIndex = gameState.currentQuestion + 1;
                
                if (nextQuestionIndex >= gameState.questions.length) {
                    await finishGame();
                } else {
                    await database.ref(`rooms/${currentRoom}/info`).update({
                        currentQuestion: nextQuestionIndex,
                        questionStartTime: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            }, 2000);
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
        async function finishGame() {
            if (isHost) {
                await database.ref(`rooms/${currentRoom}/info`).update({
                    status: 'finished',
                    questionEndTime: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function showResults(roomData) {
            if (!roomData) {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã
                database.ref(`rooms/${currentRoom}`).once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        showResults(snapshot.val());
                    }
                });
                return;
            }

            showScreen('resultsScreen');
            document.getElementById('hostResultsControls').style.display = isHost ? 'block' : 'none';

            const players = Object.values(roomData.players || {});
            players.sort((a, b) => b.score - a.score || a.name.localeCompare(b.name)); // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –±–∞–ª–ª–∞–º, –∑–∞—Ç–µ–º –ø–æ –∏–º–µ–Ω–∏ –ø—Ä–∏ —Ä–∞–≤–Ω—ã—Ö –±–∞–ª–ª–∞—Ö

            const leaderboard = document.getElementById('leaderboard');
            leaderboard.innerHTML = '<h3>üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h3>';

            players.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                
                let positionClass = '';
                if (index === 0) positionClass = 'gold';
                else if (index === 1) positionClass = 'silver';
                else if (index === 2) positionClass = 'bronze';
                
                item.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <span class="position ${positionClass}">${index + 1}</span>
                        <span>${player.name}</span>
                    </div>
                    <span>${player.score} –æ—á–∫–æ–≤</span>
                `;
                leaderboard.appendChild(item);
            });
        }

        // –ù–æ–≤–∞—è –∏–≥—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ö–æ—Å—Ç–∞)
        async function startNewGame() {
            if (!isHost) return;

            try {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—á–∫–∏ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
                const roomRef = database.ref(`rooms/${currentRoom}`);
                const playersSnapshot = await roomRef.child('players').once('value');
                const players = playersSnapshot.val();
                
                const updates = {};
                Object.keys(players).forEach(playerId => {
                    updates[`players/${playerId}/score`] = 0;
                });

                // –í—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–µ —Å–ª—É—á–∞–π–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
                const shuffled = questionsBank.sort(() => 0.5 - Math.random());
                const selectedQuestions = shuffled.slice(0, 10);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
                updates['info/status'] = 'playing';
                updates['info/currentQuestion'] = 0;
                updates['info/questionStartTime'] = firebase.database.ServerValue.TIMESTAMP;
                updates['questions'] = selectedQuestions;
                updates['answers'] = {};

                await roomRef.update(updates);

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                gameState.questions = selectedQuestions;
                gameState.currentQuestion = 0;
                gameState.score = 0;
                gameState.answers = {};
                
                showScreen('gameScreen');
                displayQuestion();

            } catch (error) {
                showError('homeError', '–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–π –∏–≥—Ä—ã: ' + error.message);
            }
        }

        // –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É
        async function leaveRoom() {
            try {
                if (!currentRoom || !currentPlayer) return;

                const roomRef = database.ref(`rooms/${currentRoom}`);
                
                if (isHost) {
                    // –ï—Å–ª–∏ —Ö–æ—Å—Ç –ø–æ–∫–∏–¥–∞–µ—Ç, —É–¥–∞–ª—è–µ–º –∫–æ–º–Ω–∞—Ç—É
                    await roomRef.remove();
                } else {
                    // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
                    await roomRef.child(`players/${currentPlayer.id}`).remove();
                    await roomRef.child(`answers`).child(currentPlayer.id).remove();
                }

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                currentRoom = null;
                currentPlayer = null;
                isHost = false;
                gameState = {
                    currentQuestion: 0,
                    questions: [],
                    answers: {},
                    score: 0,
                    timeLeft: 10,
                    timerInterval: null
                };

                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏
                roomRef.off();
                database.ref(`rooms/${currentRoom}/info`).off();

                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
                showScreen('homeScreen');
                document.getElementById('playerName').value = '';
                document.getElementById('roomCode').value = '';

            } catch (error) {
                showError('homeError', '–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã: ' + error.message);
            }
        }

        // –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é
        function backToHome() {
            leaveRoom();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomCode = urlParams.get('room');
            if (roomCode) {
                document.getElementById('roomCode').value = roomCode;
            }
        };
    </script>
</body>
</html>
